(function(c,d,a){a.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)};var b=function(){var e=this;e.params={juriRoot:"",versionUID:"0"};e.iOS=/iPad|iPod|iPhone/.test(c.navigator.userAgent);e.activeWrapper=null;e.activeWrapperForModal=null;e.activeControllerPanel=null;e.init=function(f){d.extend(e.params,f);if(e.iOS){d(c.document.body).css("cursor","pointer")}d(e.onReady)};e.addEvent=function(g,f,h){if(typeof f.on!=="undefined"){f.on(g,h)}else{if(f["on"+g.capitalizeFirstLetter()]){f["on"+g.capitalizeFirstLetter()].add(h)}}};e.isEmpty=function(f){return f.length===0};e.isDefined=function(f){return(typeof f!=="undefined")&&(f!==null)};e.makeId=function(){var h="";var f="abcdefghijklmnopqrstuvwxyz0123456789";for(var g=0;g<5;g++){h+=f.charAt(Math.floor(Math.random()*f.length))}return h};e.onReady=function(){if(e.tinymceIsAvailable()){var f=c.setInterval(function(){e.editor=e.getEditor();if(e.editor!==null&&typeof e.editor.getDoc()!=="undefined"){c.clearInterval(f);f=null;e.onFindEditor()}},200)}};e.tinymceIsAvailable=function(){return typeof c.tinymce==="object"};e.controllerPanelIsActive=function(){return typeof e.activeControllerPanel!=="undefined"&&e.activeControllerPanel!==null};e.getEditor=function(){if(c.tinymce.editors.length===0){return null}return c.tinymce.activeEditor};e.getParsedContent=function(g,f){d.ajax({type:"POST",url:"index.php?plg_task=osembedpreview.parse_content",data:{content:g},success:f,dataType:"json",async:true})};e.addStylesheet=function(f){var g=e.editor.getDoc().getElementsByTagName("head")[0];$style=d('<link rel="stylesheet" type="text/css" href="'+e.params.juriRoot+f+'">');$style.appendTo(g)};e.convertURLSchemeToPattern=function(f){var h="(.*)((?:http|osembed)s?:\\/\\/(?:www\\.)?",i="[\\/]?)(.*)",g;f=f.replace(/\*/g,"[a-zA-Z0-9=&_\\-\\?\\.\\/!\\+%:@,#]+");f=f.replace(/\./g,"\\.");f=f.replace(/\//g,"\\/");return h+f+i};e.getProvidersURLPatterns=function(){var h=["youtube.com/watch\\?*","youtu.be/*","ifttt.com/recipes/*","flickr.com/photos/*/*","flic.kr/p/*","viddler.com/v/*","hulu.com/watch/*","vimeo.com/*","player.vimeo.com/*","vimeo.com/groups/*/videos/*","collegehumor.com/video/*","*.deviantart.com/art/*","*.deviantart.com/*#/d*","fav.me/*","sta.sh/*","slideshare.net/*/*","fr.slideshare.net/*/*","de.slideshare.net/*/*","es.slideshare.net/*/*","pt.slideshare.net/*/*","chirb.it/*","*.nfb.ca/film/*","scribd.com/doc/*","dotsub.com/view/*","animoto.com/play/*","*.rdio.com/artist/*","*.rdio.com/people/*","mixcloud.com/*/*/","funnyordie.com/videos/*","ted.com/talks/*","videos.sapo.pt/*","official.fm/tracks/*","official.fm/playlists/*","huffduffer.com/*/*","shoudio.com/*","shoud.io/*","mobypicture.com/user/*/view/*","moby.to/*","23hq.com/*/photo/*","cacoo.com/diagrams/*","dipity.com/*/*/","roomshare.jp/post/*","roomshare.jp/en/post/*","dailymotion.com/video/*","crowdranking.com/*/*","circuitlab.com/circuit/*","coub.com/view/*","coub.com/embed/*","speakerdeck.com/*/*","instagram.com/p/*","instagr.am/p/*","soundcloud.com/*","on.aol.com/video/*","kickstarter.com/projects/*","*.ustream.tv/*","*.ustream.com/*","dailymile.com/people/*/entries/*","sketchfab.com/models/*","sketchfab.com/*/folders/*","meetup.com/*","meetu.ps/*","audiosnaps.com/k/*","rapidengage.com/s/*","gty.im/*","live.amcharts.com/*","infogr.am/*","public.chartblocks.com/c/*","rwire.com/*","shortnote.jp/view/notes/*","egliseinfo.catholique.fr/*","*.silk.co/explore/*","*.silk.co/s/embed/*","twitter.com/*/status/*","bambuser.com/v/*","clyp.it/*","edocr.com/doc/*","gist.github.com/*","issuu.com/*","portfolium.com/*","reverbnation.com/*","rutube.ru/video/*","open.spotify.com/*","videojug.com/*","vine.co/*","facebook.com/*","google.com/*","google.com.*/*","maps.google.com/*","docs.google.com/presentation/*","docs.google.com/document/*","docs.google.com/spreadsheets/*","docs.google.com/forms/*","docs.google.com/drawings/*","animatron.com/project/*","codepoints.net/*","gfycat.com/*"],g=[];e.each(h,function f(i){g.push(e.convertURLSchemeToPattern(i))});return g};e.addScript=function(h,j){var i=e.editor.getDoc(),g=d(i.createElement("script")),f=d(i.getElementsByTagName("head")[0]);g.attr("async",1);f.append(g);if(typeof j!=="undefined"){g.ready(j)}g.attr("src",h)};e.addScriptDeclaration=function(i,h){var g=e.editor.getDoc(),f=d(g.createElement("script"));d(i).append(f);f.text(h)};e.createGhostNode=function(f,h){f=f||"div";h=h||".";var i=new e.Node(f,1);i.attr({"class":"hidden"});var g=new e.Node("#text",3);g.value=h;i.append(g);return i};e.addURLsPlaceholder=function(j,g){var h=e.makeId();var l=new e.Node("div",1);l.attr({"class":"osembed_wrapper osembed_placeholder","data-url":g,"data-uid":h,id:"osembed_wrapper_"+h,"data-loading-text":"Loading..."});var f=new e.Node("div",1);f.attr({id:"osembed_controller_panel_"+h,"class":"osembed_controller_panel osembed_ignore_mouseout hidden"});l.append(f);var k=new e.Node("div",1);k.attr({id:"osembed_button_edit_"+h,"class":"osembed_ignore_mouseout osembed_controller_button"});editButtonIcon=new e.Node("div",1);editButtonIcon.attr({"class":"osembed-icon-pencil osembed_ignore_mouseout",style:"color: #fff;"});editButtonIcon.append(e.createGhostNode());k.append(editButtonIcon);f.append(k);var i=new e.Node("div",1);i.attr({id:"osembed_button_remove_"+h,"class":"osembed_ignore_mouseout osembed_controller_button"});removeButtonIcon=new e.Node("div",1);removeButtonIcon.attr({"class":"osembed-icon-x osembed_ignore_mouseout",style:"color: #fff;"});removeButtonIcon.append(e.createGhostNode());i.append(removeButtonIcon);f.append(i);j.replace(l);c.setTimeout(function(){e.parseContentAsync(h,g)},800);return l};e.parseContentAsync=function(h,f){f=e.decodeEmbedURLSpecialChars(f);e.getParsedContent(f,function g(j){var k;try{k=d(j.data.content)}catch(l){k=d("<div>");k.html(j.data.content)}var m=d(e.getElementInContentById("osembed_wrapper_"+h));var i=[];m.removeClass("osembed_placeholder");d.each(k,function n(o,p){if(p.tagName.toLowerCase()!=="script"){m.append(d(p));if(p.tagName.toLowerCase()==="iframe"){d(p).ready(function(){c.setTimeout(function(){d.each(e.editor.dom.select("div.osembed_wrapper iframe"),function(q,r){e.fixIframeSize(r)})},300)})}i.combine(k.children().filter("script"))}else{i.append(p)}});if(i.length>0){d.each(i,function(o,p){if(typeof d(p).attr("src")!=="undefined"){e.addScript(d(p).attr("src"))}else{e.addScriptDeclaration(m,d(p).html())}})}})};e.encodeEmbedURLSpecialChars=function(f){f=f.replace(/http(s?)\:\/\//i,"osembed$1://");f=f.replace("@","::__at__::");return f};e.decodeEmbedURLSpecialChars=function(f){f=f.replace(/osembed(s?):\/\//,"http$1://");f=f.replace("::__at__::","@");return f};e.onFindEditor=function(){e.each=tinymce.each;e.extend=tinymce.extend;e.JSON=tinymce.util.JSON;e.Node=tinymce.html.Node;e.addStylesheet("/media/plg_system_osembedpreview/css/preview.css?"+e.params.versionUID);e.addStylesheet("/media/plg_content_osembed/css/osembed.css?"+e.params.versionUID);e.addEvent("paste",e.editor,e.onPaste);e.addEvent("nodechange",e.editor,e.onNodeChange);e.addEvent("keydown",e.editor,e.onKeyDown);e.addEvent("undo",e.editor,e.onUndo);e.addEvent("undo",e.editor.undoManager,e.onUndo);e.editor.parser.addNodeFilter("#text",function h(k,j){e.each(k,function l(o){var n=e.getProvidersURLPatterns();e.each(n,function m(u){var w=new RegExp(u),s,x;x=e.decodeEmbedURLSpecialChars(o.value);s=x.match(w);if(s){var r=s[1];var z=r[r.length-1];var v=z==='"'||z==="'";var q=e.encodeEmbedURLSpecialChars(s[2]);var t=s[3];if(v){return}v=z=undefined;if(d.inArray(o.parent.name,e.params.ignoreTags)>-1){return}var p=e.addURLsPlaceholder(o,q);var y;if(r!==""){y=new e.Node("#text",3);y.value=r.trim();p.parent.insert(y,p,true)}if(t!==""){y=new e.Node("#text",3);y.value=t.trim();p.parent.insert(y,p,false)}}})})});e.editor.serializer.addNodeFilter("div",function g(k,j){e.each(k,function l(m){if(m.attributes.map["class"]==="osembed_wrapper"||m.attributes.map["class"]==="osembed_placeholder"){text=new e.Node("#text",3);text.value=e.decodeEmbedURLSpecialChars(m.attributes.map["data-url"].trim());m.replace(text)}})});tinymce.each(tinymce.editors,function i(j){e.addEvent("loadContent",j,function k(l){e.configureWrappers()})});c.setTimeout(function f(){e.editor.load()},500)};e.fixIframeSize=function(g){var h=480;if(d(g).width()>h&&!d(g).data("size-fixed")){var f=d(g).height()/d(g).width();d(g).width(h);d(g).height(h*f);d(g).css("max-width",h);d(g).attr("max-width",h);d(g).data("size-fixed",true)}};e.onMouseEnter=function(f){e.displayPreviewControllerPanel(d(f.currentTarget))};e.onMouseOut=function(f){if(e.isDefined(f.toElement)){if(f.toElement.parentElement==f.fromElement||d(f.toElement).hasClass("osembed_ignore_mouseout")){return false}}if(e.isDefined(f.relatedTarget)){if(d(f.relatedTarget).hasClass("osembed_ignore_mouseout")){return false}}e.hidePreviewControllerPanel()};e.onPaste=function(k,f){var i;if(k.preventDefault){i=k}else{i=f}var h=((i.originalEvent||i).clipboardData||c.clipboardData).getData("Text");var g=e.getProvidersURLPatterns();e.each(g,function j(r){var p=new RegExp(r),q=h.match(p),m,o,l,n;if(q){l=q[1];n=l[l.length-1];o=n==='"'||n==="'";if(o){return}l=o=n=undefined;i.preventDefault();m=q[2];h=e.encodeEmbedURLSpecialChars(h);e.editor.execCommand("mceInsertContent",false,h);e.configureWrappers()}})};e.onNodeChange=function(f){if(f.element.tagName==="BR"){if(f.parents.length>0){d.each(f.parents,function(g,h){if(d(h).hasClass("osembed_wrapper")){d(h).replaceWith(d("<br>"))}})}}};e.onKeyDown=function(g){var f=e.editor.selection.getNode();if(g.keyCode==8||g.keyCode==46){if(f.nodeName.toLowerCase()==="p"){children=d(f).children();if(children.length>0){d.each(children,function(){if(d(this).hasClass("osembed_wrapper")||d(this).hasClass("osembed_ignore_mouseout")){d(this).remove();e.editor.focus()}})}}}else{var j=[37,38,39,40];if(j.indexOf(g.keyCode)==-1){if(d(f).hasClass("osembed_wrapper")||d(f).hasClass("osembed_ignore_mouseout")){if(g.keyCode==13){wrapper=d(e.getWrapperFromChild(f));if(wrapper.length>0){var i="__osembed__tmp_"+e.makeId();wrapper.after(d('<div id="'+i+'"></div>'));var h=e.editor.dom.select("div#"+i)[0];e.editor.selection.select(h);d(h).remove()}return true}else{return e.cancelEvent(g)}}}}return true};e.getWrapperFromChild=function(f){if(d(f).hasClass("osembed_wrapper")){return f}else{var g=d(f).parent();if(g.length>0){return e.getWrapperFromChild(g[0])}}return false};e.onUndo=function(f){e.editor.load()};e.cancelEvent=function(f){f.preventDefault();f.stopPropagation();e.editor.dom.events.cancel();return false};e.onClickEditButton=function(h){e.cancelEvent(h);e.activeWrapperForModal=e.activeWrapper;var g=e.activeWrapperForModal,f;f=bootbox.prompt({title:"Edit the URL",size:"small",message:"Testing..",value:e.decodeEmbedURLSpecialChars(g.data("url")),callback:function(i){if(i!==null){var j=e.activeWrapperForModal;e.editor.focus();e.editor.selection.select(j[0]);j.children().remove();j.remove();e.editor.execCommand("mceInsertContent",false,i);e.configureWrappers()}}});return false};e.onClickRemoveButton=function(g){e.cancelEvent(g);var f=e.activeWrapper;f.children().remove();f.remove();return false};e.recursivelyAddClass=function(f,g){d(f).children().each(function(i,j){d(j).addClass(g);var h=d(j).children();if(h.length>0){e.recursivelyAddClass(j,g)}})};e.setInterval=function(k,j,i){var g=0;var f=0;var h=c.setInterval(function(){g+=j;f++;if(g<=i){k(f,g)}else{e.stopInterval(h)}},j);return h};e.stopInterval=function(f){c.clearInterval(f);f=null};e.configureWrappers=function(){c.setTimeout(function f(){var n=e.editor.getDoc(),j=0,l=null,m=null;var k=n.getElementsByClassName("osembed_wrapper");j=k.length;if(j>0){for(var h=0;h<j;h++){l=d(k[h]);if(l.data("configured")!=true){c.setTimeout(function(){e.recursivelyAddClass(l,"osembed_ignore_mouseout")},500);var g=e.setInterval(function(i){var o=l.find("iframe");if(o.length>0){d.each(o,function(p,q){if(d(q).attr("id")!=="fb_xdm_frame_https"&&d(q).attr("id")!=="fb_xdm_frame_http"){l.css("width",d(q).width()+"px");e.stopInterval(g)}})}},500,8000);l.on("mouseenter",e.onMouseEnter);l.on("mouseout",e.onMouseOut);l.data("configured",true)}}}},400)};e.hidePreviewControllerPanel=function(){if(e.controllerPanelIsActive()){d(e.activeControllerPanel).addClass("hidden");e.activeControllerPanel=null;e.activeWrapper=null}};e.getElementInContentById=function(g){var f=e.editor.getDoc();return d(f.getElementById(g))};e.displayPreviewControllerPanel=function(j){if(e.controllerPanelIsActive()&&j!==e.activeWrapper){e.hidePreviewControllerPanel()}if(!e.controllerPanelIsActive()){var f=j.data("uid");var k=e.getElementInContentById("osembed_controller_panel_"+f);if(!k.data("event-set")){var i=e.getElementInContentById("osembed_button_edit_"+f);var h=e.getElementInContentById("osembed_button_remove_"+f);e.addEvent("mousedown",i,e.onClickEditButton);e.addEvent("mousedown",h,e.onClickRemoveButton);e.addEvent("mousedown",k,e.cancelEvent);k.data("event-set",true)}var g=k.next()[0];if(typeof g!=="undefined"){if(g.nodeName.toLowerCase()==="iframe"){k.css("left",(d(g).width()/2))}}k.removeClass("hidden");e.activeControllerPanel=k;e.activeWrapper=j}}};if(!c.OSEmbedPreview){c.OSEmbedPreview=new b()}})(window,jQuery,String);